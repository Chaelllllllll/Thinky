<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reset Password - Thinky</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="shortcut icon" href="../images/logo.png" type="image/x-icon">
  <style>
    .reset-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .reset-card{background:#fff;padding:28px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.06);max-width:520px;width:100%}
    .form-group{margin-bottom:12px}
    .btn{cursor:pointer}
  </style>
</head>
<body>
  <div class="reset-container">
    <div class="reset-card">
      <h2>Set a new password</h2>
      <p id="subtext">Enter a strong password for your account.</p>
      <div id="alertContainer"></div>
      <form id="resetForm">
        <input type="hidden" id="token">
        <div class="form-group">
          <label for="newPassword">New password</label>
          <input id="newPassword" type="password" class="form-control" required minlength="6" placeholder="New password">
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirm password</label>
          <input id="confirmPassword" type="password" class="form-control" required minlength="6" placeholder="Repeat password">
        </div>
        <button class="btn btn-primary w-100" id="resetBtn">Set password</button>
      </form>
    </div>
  </div>

  <script>
    function showAlert(message, type){
      const c=document.getElementById('alertContainer'); c.innerHTML=''; const el=document.createElement('div'); el.className='alert alert-'+(type||'info'); el.textContent=message; c.appendChild(el);
      if(type==='success') setTimeout(()=>el.remove(),3000);
    }

    // read token from querystring
    const qs = new URLSearchParams(location.search);
    const token = qs.get('token') || '';
    document.getElementById('token').value = token;

    document.getElementById('resetForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const pw = document.getElementById('newPassword').value;
      const pw2 = document.getElementById('confirmPassword').value;
      if(pw !== pw2){ showAlert('Passwords do not match','error'); return; }

      const btn = document.getElementById('resetBtn'); btn.disabled=true; btn.textContent='Resetting...';
      try{
        const r = await fetch('/api/auth/reset', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token, password: pw }) });
        const d = await r.json().catch(()=>({}));
        if(r.ok){ showAlert(d.message || 'Password reset', 'success'); setTimeout(()=>location.href='/login',1200); }
        else showAlert(d.error || 'Failed to reset password','error');
      }catch(err){ console.error(err); showAlert('Server error','error'); }
      finally{ btn.disabled=false; btn.textContent='Set password'; }
    });
  </script>
</body>
</html>